import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Upload, Zap, Activity, Radio, Sun, Wind, Droplets, Flame, Battery, Menu, X, Info, Layers, Waves, Leaf, Filter, Construction, Map as MapIcon, Palette, Eraser, DownloadCloud } from 'lucide-react';

// --- STYLES ---

const delayClasses = Array.from({ length: 30 }).map((_, i) => `
  .delay-${i} {
    animation-delay: ${i * 0.2}s !important;
  }
`).join('');

const styles = `
  @import url('https://fonts.googleapis.com/css2?family=Geist:wght@100..900&family=Geist+Mono:wght@100..900&display=swap');
  
  :root {
    --font-geist: 'Geist', sans-serif;
    --font-geist-mono: 'Geist Mono', monospace;
  }

  body {
    font-family: var(--font-geist);
  }

  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: #171717; }
  ::-webkit-scrollbar-thumb { background: #404040; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #525252; }

  .leaflet-popup-content-wrapper {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(4px);
    border-radius: 8px;
    padding: 0;
    overflow: hidden;
  }
  .leaflet-popup-content { margin: 10px; width: auto !important; }
  .leaflet-container { background: #171717; width: 100%; height: 100%; }

  /* --- ANIMATIONS --- */
  
  @keyframes breathe {
    0%, 60% {
      stroke-opacity: 0.2;
      stroke-width: 1px;
      stroke: #5eead4;
      filter: drop-shadow(0 0 0px rgba(94, 234, 212, 0));
    }
    80% {
      stroke-opacity: 1;
      stroke-width: 3px;
      stroke: #ffffff;
      filter: drop-shadow(0 0 6px rgba(94, 234, 212, 0.9));
    }
    100% {
      stroke-opacity: 0.2;
      stroke-width: 1px;
      stroke: #5eead4;
      filter: drop-shadow(0 0 0px rgba(94, 234, 212, 0));
    }
  }

  .pulse-line {
    stroke-dasharray: none !important;
    stroke-linecap: round;
    animation: breathe 6s ease-in-out infinite;
    z-index: 1000;
  }

  ${delayClasses}

  .planned-line {
    stroke-dasharray: 5, 10;
    opacity: 0.5;
  }
`;

// --- Utility Functions ---

const getVoltageCategory = (voltage) => {
  const v = Number(voltage);
  if (v >= 750) return '750+';
  if (v >= 600) return '600';
  if (v >= 500) return '500';
  if (v >= 440) return '440';
  if (v >= 345) return '345';
  if (v >= 230) return '230';
  return '138-';
};

const getVoltageColor = (voltage, grayMode = false) => {
  if (grayMode) return '#2dd4bf'; // Verde água padrão (Teal-400)
  
  const v = Number(voltage);
  if (v >= 750) return '#7c3aed';
  if (v >= 600) return '#db2777';
  if (v >= 500) return '#ef4444';
  if (v >= 440) return '#f59e0b';
  if (v >= 345) return '#eab308';
  if (v >= 230) return '#22c55e';
  if (v >= 138) return '#3b82f6';
  return '#64748b';
};

const getPlantCategory = (typeId, typeName) => {
  const t = (typeId || '').toUpperCase();
  const n = (typeName || '').toUpperCase();
  if (t === 'UHE' || n.includes('HIDRO')) return 'Hidrelétrica';
  if (t === 'UTE' || n.includes('TERMICA')) return 'Térmica';
  if (t === 'EOL' || n.includes('EOLICA') || n.includes('EOLIELETRICA')) return 'Eólica';
  if (t === 'UFV' || n.includes('SOLAR')) return 'Solar';
  if (t === 'UCN' || n.includes('NUCLEAR')) return 'Nuclear';
  return 'Outros';
};

const getPlantColor = (category) => {
  switch (category) {
    case 'Hidrelétrica': return '#3b82f6';
    case 'Térmica': return '#f97316';
    case 'Eólica': return '#22d3ee';
    case 'Solar': return '#fbbf24';
    case 'Nuclear': return '#a855f7';
    case 'Outros': return '#10b981'; 
    default: return '#9ca3af';
  }
};

const getDistance = (lat1, lng1, lat2, lng2) => {
  return Math.sqrt(Math.pow(lat2 - lat1, 2) + Math.pow(lng2 - lng1, 2));
};

const isOperational = (props) => {
  if (props.DTENTRADA) {
    const entryDate = new Date(props.DTENTRADA);
    if (entryDate > new Date()) return false;
  } else if (props.DTPREVISTA) {
    return false;
  }
  return true; 
};

// --- Helper Components ---

const FileUploader = ({ label, accept, onFileLoaded, loaded, icon: Icon, loading }) => {
  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const json = JSON.parse(event.target.result);
        onFileLoaded(json);
      } catch (err) {
        alert("Erro ao ler JSON: " + err.message);
      }
    };
    reader.readAsText(file);
  };

  return (
    <div className={`flex items-center justify-between p-3 mb-2 rounded-lg border transition-all duration-200 ${loaded ? 'bg-emerald-900/20 border-emerald-500/50' : 'bg-neutral-800 border-neutral-700 hover:border-neutral-500'}`}>
      <div className="flex items-center gap-3 overflow-hidden">
        <div className={`p-2 rounded-md ${loaded ? 'bg-emerald-500/20 text-emerald-400' : 'bg-neutral-700 text-neutral-400'}`}>
          <Icon size={18} />
        </div>
        <div className="flex flex-col min-w-0">
          <span className="text-sm font-medium text-neutral-200 truncate pr-2">{label}</span>
          <span className="text-xs text-neutral-500 font-mono flex items-center gap-1">
            {loading ? (
              <span className="animate-pulse">Buscando dados...</span>
            ) : (
              loaded ? 'Carregado' : 'Aguardando arquivo...'
            )}
          </span>
        </div>
      </div>
      <label className="cursor-pointer px-3 py-1.5 text-xs font-medium bg-neutral-700 hover:bg-neutral-600 text-white rounded-md transition-colors whitespace-nowrap">
        {loaded ? 'Trocar' : 'Carregar'}
        <input type="file" accept={accept} onChange={handleFileChange} className="hidden" />
      </label>
    </div>
  );
};

const LegendItem = ({ color, label, subLabel }) => (
  <div className="flex items-center gap-3 py-1">
    <div className="w-3 h-3 rounded-full shadow-sm" style={{ backgroundColor: color }}></div>
    <div className="flex flex-col">
      <span className="text-xs text-neutral-300 font-medium">{label}</span>
      {subLabel && <span className="text-[10px] text-neutral-500">{subLabel}</span>}
    </div>
  </div>
);

// --- Main App Component ---

export default function App() {
  // Data States
  const [transmissao, setTransmissao] = useState(null);
  const [dc, setDc] = useState(null);
  const [subestacoes, setSubestacoes] = useState(null);
  const [usinas, setUsinas] = useState(null);
  
  // Loading States for auto-fetch
  const [loadingStates, setLoadingStates] = useState({
    transmissao: false,
    dc: false,
    subestacoes: false,
    usinas: false
  });
  
  // UI States
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [activeTab, setActiveTab] = useState('files');
  const [leafletReady, setLeafletReady] = useState(false);
  
  // Modes
  const [pulseMode, setPulseMode] = useState(false);
  const [pulsingLines, setPulsingLines] = useState(new Map()); 
  const [selectedPlant, setSelectedPlant] = useState(null); // {lat, lng}

  // Filters
  const [showPlanned, setShowPlanned] = useState(false); 
  const [grayMode, setGrayMode] = useState(false);
  const [layers, setLayers] = useState({ ac: true, dc: true, subs: true, plants: true });
  
  const [voltageFilters, setVoltageFilters] = useState({
    '750+': true, '600': true, '500': true, '440': true, '345': true, '230': true, '138-': true
  });

  const [plantFilters, setPlantFilters] = useState({
    'Hidrelétrica': true, 'Térmica': true, 'Eólica': true, 'Solar': true, 'Nuclear': true, 'Outros': true
  });

  const mapContainerRef = useRef(null);
  const mapInstanceRef = useRef(null);
  const layerGroupsRef = useRef({ ac: null, dc: null, subs: null, plants: null });

  // Load Leaflet
  useEffect(() => {
    if (window.L && typeof window.L.map === 'function') {
      setLeafletReady(true);
      return;
    }
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(link);
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.async = true;
    script.onload = () => { if (window.L) setLeafletReady(true); };
    document.body.appendChild(script);
  }, []);

  // --- AUTO FETCH DATA ON MOUNT ---
  useEffect(() => {
    const fetchGeoJSON = async (url, setter, key) => {
      setLoadingStates(prev => ({ ...prev, [key]: true }));
      try {
        const response = await fetch(url);
        if (response.ok) {
          const data = await response.json();
          setter(data);
        } else {
          console.warn(`Arquivo não encontrado ou erro ao carregar: ${url}`);
        }
      } catch (error) {
        console.warn(`Falha ao buscar ${url}:`, error);
      } finally {
        setLoadingStates(prev => ({ ...prev, [key]: false }));
      }
    };

    // Tenta carregar os arquivos da raiz (útil para GitHub Pages)
    fetchGeoJSON('transmissao.geojson', setTransmissao, 'transmissao');
    fetchGeoJSON('correntecontinua.geojson', setDc, 'dc');
    fetchGeoJSON('subestacoes.geojson', setSubestacoes, 'subestacoes');
    fetchGeoJSON('usinas.geojson', setUsinas, 'usinas');
  }, []);

  // Initialize Map
  useEffect(() => {
    if (!leafletReady || !mapContainerRef.current) return;
    if (mapInstanceRef.current) { mapInstanceRef.current.remove(); mapInstanceRef.current = null; }

    const L = window.L;
    if (!L) return;

    try {
      const map = L.map(mapContainerRef.current, { zoomControl: false, attributionControl: false })
        .setView([-15.793889, -47.882778], 4);
      
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap', subdomains: 'abcd', maxZoom: 20
      }).addTo(map);

      const svgRenderer = L.svg();

      layerGroupsRef.current.ac = L.layerGroup({ renderer: svgRenderer }).addTo(map);
      layerGroupsRef.current.dc = L.layerGroup({ renderer: svgRenderer }).addTo(map);
      layerGroupsRef.current.subs = L.layerGroup({ renderer: svgRenderer }).addTo(map);
      layerGroupsRef.current.plants = L.layerGroup({ renderer: svgRenderer }).addTo(map);

      mapInstanceRef.current = map;
    } catch (e) { console.error(e); }

    return () => { if (mapInstanceRef.current) { mapInstanceRef.current.remove(); mapInstanceRef.current = null; } };
  }, [leafletReady]);

  // --- RECURSIVE PULSE LOGIC (BFS) ---
  const handlePlantPulse = (plantLat, plantLng) => {
    if (!transmissao || !pulseMode) return;
    
    setSelectedPlant({ lat: plantLat, lng: plantLng });

    const QUEUE_LIMIT = 800; 
    const MAX_DEPTH = 25;
    const THRESHOLD = 0.4;

    const visitedLines = new Map();
    const queue = [{ lat: plantLat, lng: plantLng, depth: 0 }];
    let iterations = 0;

    while (queue.length > 0 && iterations < QUEUE_LIMIT) {
      const current = queue.shift();
      if (current.depth >= MAX_DEPTH) continue;

      transmissao.features.forEach((feature, idx) => {
        if (visitedLines.has(idx)) return;
        if (!showPlanned && !isOperational(feature.properties)) return; 
        
        const vCat = getVoltageCategory(feature.properties.VN);
        if (!voltageFilters[vCat]) return;

        if (!feature.geometry || !feature.geometry.coordinates) return;

        const coords = feature.geometry.coordinates;
        // GeoJSON geometry is [lng, lat]
        const start = coords[0]; 
        const end = coords[coords.length - 1];

        const distStart = getDistance(current.lat, current.lng, start[1], start[0]);
        const distEnd = getDistance(current.lat, current.lng, end[1], end[0]);

        if (distStart < THRESHOLD) {
          visitedLines.set(idx, { reversed: false, depth: current.depth }); 
          queue.push({ lat: end[1], lng: end[0], depth: current.depth + 1 });
        } else if (distEnd < THRESHOLD) {
          visitedLines.set(idx, { reversed: true, depth: current.depth }); 
          queue.push({ lat: start[1], lng: start[0], depth: current.depth + 1 });
        }
      });
      iterations++;
    }

    if (visitedLines.size > 0) {
      setPulsingLines(visitedLines);
    } else {
      console.log("Nenhuma linha conectada encontrada.");
    }
  };

  const clearPulse = () => {
    setPulsingLines(new Map());
    setSelectedPlant(null);
  };

  const createPopupContent = (title, type, details) => {
    const detailsHtml = Object.entries(details)
      .filter(([_, val]) => val)
      .map(([key, val]) => `
        <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 2px;">
          <span style="color: #6b7280; font-family: monospace;">${key}:</span>
          <span style="color: #1f2937; font-weight: 500; margin-left: 8px; text-align: right;">${val}</span>
        </div>
      `).join('');
    return `<div style="font-family: 'Geist', sans-serif; min-width: 200px;">
      <h3 style="font-weight: 700; font-size: 13px; margin: 0 0 8px 0; border-bottom: 1px solid #e5e7eb; padding-bottom: 4px; color: #111827;">${title || 'Sem Nome'}</h3>
      <div>${detailsHtml}</div>
      <div style="margin-top: 8px; padding-top: 4px; border-top: 1px solid #f3f4f6; font-size: 9px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; text-align: right;">${type}</div>
    </div>`;
  };

  // Render AC Lines
  useEffect(() => {
    if (!mapInstanceRef.current || !layerGroupsRef.current.ac) return;
    const group = layerGroupsRef.current.ac;
    group.clearLayers();

    if (transmissao && layers.ac) {
      const L = window.L;
      transmissao.features.forEach((f, idx) => {
        if (!f.geometry || !f.geometry.coordinates) return;
        
        const props = f.properties;
        const operational = isOperational(props);
        if (!showPlanned && !operational) return; 

        const vCat = getVoltageCategory(props.VN);
        if (!voltageFilters[vCat]) return;

        let coords = f.geometry.coordinates.map(c => [c[1], c[0]]); // [lat, lng]
        
        // --- Pulse Mode Logic ---
        const pulseData = pulsingLines.get(idx);
        const isPulsing = !!pulseData;
        const shouldReversePulse = pulseData?.reversed;
        const depth = pulseData?.depth || 0;
        
        if (pulseMode && isPulsing && shouldReversePulse) {
            coords = coords.reverse();
        }

        let opacity = 0.8;
        if (pulseMode) {
            opacity = isPulsing ? 1.0 : 0.05; 
        }

        const className = [
          isPulsing ? 'pulse-line' : '',
          isPulsing ? `delay-${Math.min(depth, 29)}` : '', 
          (!operational) ? 'planned-line' : ''
        ].filter(Boolean).join(' '); 

        const polyline = L.polyline(coords, {
          color: getVoltageColor(props.VN, grayMode), 
          weight: isPulsing ? 3 : 1.5,
          opacity: opacity,
          className: className || undefined,
          dashArray: operational ? null : '5, 10'
        });

        if (!pulseMode) {
          polyline.bindPopup(createPopupContent(props.NOMELONGO, operational ? 'LINHA DE TRANSMISSÃO' : 'EXPANSÃO PLANEJADA', { 
            'Tensão': `${props.VN} kV`, 
            'Agente': props.AGE_NOME,
            'Entrada': props.STR_DTENTRADA || 'N/A',
            'Previsão': props.STR_DTPREVISTA || 'N/A'
          }));
        }
        group.addLayer(polyline);
      });
    }
  }, [transmissao, layers.ac, leafletReady, pulsingLines, pulseMode, showPlanned, grayMode, voltageFilters]);

  // Render Plants
  useEffect(() => {
    if (!mapInstanceRef.current || !layerGroupsRef.current.plants) return;
    const group = layerGroupsRef.current.plants;
    group.clearLayers();

    if (usinas && layers.plants) {
      const L = window.L;
      usinas.features.forEach(f => {
        if (!f.geometry) return;
        const [lng, lat] = f.geometry.coordinates;
        const props = f.properties;
        
        const operational = isOperational(props);
        if (!showPlanned && !operational) return;

        const category = getPlantCategory(props.TPUSINA_ID, props.NOME_TPUSINA);
        if (!plantFilters[category]) return;

        const color = getPlantColor(category);

        let opacity = 0.8;
        let isSelected = false;

        if (pulseMode) {
            if (selectedPlant) {
                isSelected = (selectedPlant.lat === lat && selectedPlant.lng === lng);
                opacity = isSelected ? 1 : 0.1;
            } else {
                // If no plant is selected yet in interactive modes, dim slightly
                opacity = 0.8;
            }
        }

        const marker = L.circleMarker([lat, lng], {
          radius: (pulseMode && isSelected) ? 8 : 4,
          color: (pulseMode && isSelected) ? '#fff' : '#000',
          weight: (pulseMode && isSelected) ? 2 : 1,
          fillColor: color,
          fillOpacity: opacity,
          className: pulseMode ? 'cursor-pointer hover:stroke-white' : undefined 
        });

        marker.on('click', () => { 
            if (pulseMode) {
                handlePlantPulse(lat, lng); 
            }
        });
        
        if (!pulseMode) {
          marker.bindPopup(createPopupContent(props.NOMELONGO, operational ? 'USINA GERADORA' : 'USINA (PLANEJADA)', { 'Tipo': props.NOME_TPUSINA, 'Código': props.INS_ID }));
        } else {
           marker.bindTooltip("Clique para propagar pulso", { direction: 'top' });
        }
        group.addLayer(marker);
      });
    }
  }, [usinas, layers.plants, leafletReady, pulseMode, plantFilters, showPlanned, selectedPlant]);

  // Other layers (DC, Subs)
  useEffect(() => {
    if (!mapInstanceRef.current || !layerGroupsRef.current.dc) return;
    const group = layerGroupsRef.current.dc;
    group.clearLayers();
    if (dc && layers.dc) {
      const L = window.L;
      dc.features.forEach(f => {
        if (!showPlanned && !isOperational(f.properties)) return;
        const coords = f.geometry.coordinates.map(c => [c[1], c[0]]);
        const poly = L.polyline(coords, { color: grayMode ? '#525252' : '#db2777', weight: 2.5, dashArray: '5,5', opacity: pulseMode ? 0.05 : 1 });
        poly.bindPopup(createPopupContent(f.properties.NOMELONGO, 'HVDC', { 'ID': f.properties.INS_ID }));
        group.addLayer(poly);
      });
    }
  }, [dc, layers.dc, leafletReady, pulseMode, showPlanned, grayMode]);

  useEffect(() => {
    if (!mapInstanceRef.current || !layerGroupsRef.current.subs) return;
    const group = layerGroupsRef.current.subs;
    group.clearLayers();
    if (subestacoes && layers.subs) {
      const L = window.L;
      subestacoes.features.forEach(f => {
        if (!showPlanned && !isOperational(f.properties)) return;
        const [lng, lat] = f.geometry.coordinates;
        // Substations white by default, dim in pulse mode
        const m = L.circleMarker([lat, lng], { radius: 2, color: '#fff', fillColor: '#fff', weight: 0, fillOpacity: pulseMode ? 0.05 : 0.8 });
        m.bindPopup(createPopupContent(f.properties.NOMELONGO, 'SUBESTAÇÃO', { 'ID': f.properties.INS_ID }));
        group.addLayer(m);
      });
    }
  }, [subestacoes, layers.subs, leafletReady, pulseMode, showPlanned]);

  const stats = useMemo(() => {
    let kmTotal = 0, usinasTotal = 0, cleanCount = 0;
    
    if (transmissao?.features) {
      kmTotal += transmissao.features.reduce((acc, f) => acc + (f.properties['SHAPE.STLength()'] || 0.5), 0);
    }
    if (usinas?.features) {
      const filtered = usinas.features.filter(f => showPlanned || isOperational(f.properties));
      usinasTotal = filtered.length;
      cleanCount = filtered.filter(f => {
        const type = (f.properties.TPUSINA_ID || '').toUpperCase();
        const name = (f.properties.NOME_TPUSINA || '').toUpperCase();
        const category = getPlantCategory(type, name);
        return ['Hidrelétrica', 'Eólica', 'Solar', 'Outros'].includes(category);
      }).length;
    }
    
    const cleanPercentage = usinasTotal > 0 ? Math.round((cleanCount / usinasTotal) * 100) : 0;
    
    return { estimatedKm: Math.round(kmTotal * 111), usinasTotal, cleanPercentage };
  }, [transmissao, usinas, showPlanned]);

  const toggleLayer = (k) => setLayers(p => ({ ...p, [k]: !p[k] }));
  const togglePlantFilter = (k) => setPlantFilters(p => ({ ...p, [k]: !p[k] }));
  const toggleVoltageFilter = (k) => setVoltageFilters(p => ({ ...p, [k]: !p[k] }));

  return (
    <div className="flex h-screen w-full bg-neutral-950 text-white overflow-hidden relative">
      <style>{styles}</style>

      {/* Sidebar */}
      <div className={`absolute z-[1000] top-0 left-0 h-full bg-neutral-900/95 backdrop-blur-md border-r border-neutral-800 transition-all duration-300 ease-in-out flex flex-col ${sidebarOpen ? 'w-80 translate-x-0' : 'w-80 -translate-x-full'}`}>
        <div className="p-5 border-b border-neutral-800 flex justify-between items-center bg-neutral-900">
          <div>
            <h1 className="font-bold text-lg tracking-tight flex items-center gap-2">
              <Activity className="text-emerald-500" size={20} />
              SIN Interativo
            </h1>
            <p className="text-xs text-neutral-500 font-mono mt-1">Sistema Interligado Nacional</p>
          </div>
          <button onClick={() => setSidebarOpen(false)} className="p-1 hover:bg-neutral-800 rounded text-neutral-400"><X size={20} /></button>
        </div>

        {/* --- MODES PANEL --- */}
        <div className="p-4 border-b border-neutral-800 bg-neutral-800/30 space-y-3">
          {/* Pulse Mode */}
          <button onClick={() => { setPulseMode(!pulseMode); clearPulse(); }}
            className={`w-full py-2.5 px-3 rounded-md flex items-center justify-between font-medium transition-all text-sm border ${pulseMode ? 'bg-indigo-600 border-indigo-500 text-white' : 'bg-neutral-800 border-neutral-700 text-neutral-400 hover:bg-neutral-700'}`}>
            <span className="flex items-center gap-2"><Waves size={16} /> Modo Pulso</span>
            {pulseMode && <div className="w-2 h-2 bg-white rounded-full animate-pulse"></div>}
          </button>
          
          {pulseMode && selectedPlant && (
             <button onClick={clearPulse} className="w-full py-2 px-3 text-xs bg-red-900/30 text-red-300 border border-red-800/50 rounded hover:bg-red-900/50 flex items-center justify-center gap-2">
                <Eraser size={12}/> Desselecionar Usina
             </button>
          )}
          
          <p className="text-[10px] text-neutral-500 text-center px-1">
            {pulseMode ? (selectedPlant ? 'Visualizando propagação.' : 'Clique em uma usina para iniciar.') : 'Explore os modos interativos.'}
          </p>
        </div>

        {/* Clean Energy Grid Icon */}
        <div className="mx-5 mt-4 p-4 bg-gradient-to-br from-emerald-900/40 to-neutral-900 border border-emerald-800/50 rounded-xl flex items-center justify-between shadow-lg">
          <div>
            <p className="text-[10px] text-emerald-400 uppercase font-bold tracking-widest mb-1">Matriz Renovável</p>
            <div className="flex items-baseline gap-1">
              <span className="text-2xl font-bold text-white">{stats.cleanPercentage}%</span>
              <span className="text-xs text-neutral-400">do grid</span>
            </div>
          </div>
          <div className="p-2 bg-emerald-500/20 rounded-lg text-emerald-400">
             <Leaf size={24} />
          </div>
        </div>

        {/* Tabs */}
        <div className="flex border-b border-neutral-800 mt-2">
          <button onClick={() => setActiveTab('files')} className={`flex-1 py-3 text-xs font-medium uppercase tracking-wider ${activeTab === 'files' ? 'text-emerald-400 border-b-2 border-emerald-500' : 'text-neutral-500'}`}>Dados</button>
          <button onClick={() => setActiveTab('filters')} className={`flex-1 py-3 text-xs font-medium uppercase tracking-wider ${activeTab === 'filters' ? 'text-emerald-400 border-b-2 border-emerald-500' : 'text-neutral-500'}`}>Filtros</button>
          <button onClick={() => setActiveTab('legend')} className={`flex-1 py-3 text-xs font-medium uppercase tracking-wider ${activeTab === 'legend' ? 'text-emerald-400 border-b-2 border-emerald-500' : 'text-neutral-500'}`}>Legenda</button>
        </div>

        {/* Tab Content */}
        <div className="flex-1 overflow-y-auto p-5 space-y-6">
          {activeTab === 'files' && (
            <div className="animate-in fade-in slide-in-from-left-4 duration-300">
               <div className="mb-4 text-xs text-neutral-400 bg-neutral-900/50 p-3 rounded border border-neutral-800">
                 <p className="flex items-center gap-2"><DownloadCloud size={14}/> Carregamento automático ativado</p>
                 <p className="mt-1 opacity-60">O sistema busca os arquivos .geojson automaticamente na raiz.</p>
               </div>

               <FileUploader label="Transmissão (AC)" accept=".geojson,.json" icon={Zap} loaded={!!transmissao} loading={loadingStates.transmissao} onFileLoaded={setTransmissao} />
               <FileUploader label="Usinas Geradoras" accept=".geojson,.json" icon={Flame} loaded={!!usinas} loading={loadingStates.usinas} onFileLoaded={setUsinas} />
               <FileUploader label="Corrente Contínua" accept=".geojson,.json" icon={Battery} loaded={!!dc} loading={loadingStates.dc} onFileLoaded={setDc} />
               <FileUploader label="Subestações" accept=".geojson,.json" icon={Radio} loaded={!!subestacoes} loading={loadingStates.subestacoes} onFileLoaded={setSubestacoes} />
            </div>
          )}

          {activeTab === 'filters' && (
             <div className="space-y-6 animate-in fade-in slide-in-from-left-4">
               <div>
                  <h3 className="text-xs font-bold text-neutral-500 uppercase mb-3 flex items-center gap-2"><Construction size={14}/> Planejamento</h3>
                  <button 
                    onClick={() => setShowPlanned(!showPlanned)} 
                    className={`w-full flex justify-between items-center text-xs p-2 rounded border transition-colors ${showPlanned ? 'bg-amber-900/30 border-amber-600 text-amber-500' : 'border-neutral-800 text-neutral-600'}`}
                  >
                    <span>Mostrar Expansões Futuras</span>
                    {showPlanned && <div className="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></div>}
                  </button>
               </div>

               <div>
                  <h3 className="text-xs font-bold text-neutral-500 uppercase mb-3 flex items-center gap-2"><Layers size={14}/> Camadas Principais</h3>
                  <div className="space-y-2">
                    <button onClick={() => toggleLayer('ac')} className={`w-full flex justify-between items-center text-xs p-2 rounded border transition-colors ${layers.ac ? 'bg-neutral-800 border-neutral-600 text-white' : 'border-neutral-800 text-neutral-600'}`}>
                      <span>Linhas de Transmissão</span> <div className={`w-2 h-2 rounded-full ${layers.ac ? 'bg-emerald-500' : 'bg-neutral-700'}`}></div>
                    </button>
                    <button onClick={() => toggleLayer('plants')} className={`w-full flex justify-between items-center text-xs p-2 rounded border transition-colors ${layers.plants ? 'bg-neutral-800 border-neutral-600 text-white' : 'border-neutral-800 text-neutral-600'}`}>
                      <span>Usinas Geradoras</span> <div className={`w-2 h-2 rounded-full ${layers.plants ? 'bg-orange-500' : 'bg-neutral-700'}`}></div>
                    </button>
                    <button onClick={() => toggleLayer('subs')} className={`w-full flex justify-between items-center text-xs p-2 rounded border transition-colors ${layers.subs ? 'bg-neutral-800 border-neutral-600 text-white' : 'border-neutral-800 text-neutral-600'}`}>
                      <span>Subestações</span> <div className={`w-2 h-2 rounded-full ${layers.subs ? 'bg-white' : 'bg-neutral-700'}`}></div>
                    </button>
                  </div>
               </div>

               <div>
                  <h3 className="text-xs font-bold text-neutral-500 uppercase mb-3 flex items-center gap-2"><Filter size={14}/> Filtrar Tensão (kV)</h3>
                  <div className="mb-3">
                    <button onClick={() => setGrayMode(!grayMode)} className={`w-full flex justify-between items-center text-xs p-2 rounded border transition-colors ${grayMode ? 'bg-teal-900/30 border-teal-600 text-teal-400' : 'border-neutral-800 text-neutral-600'}`}>
                      <div className="flex items-center gap-2"><Palette size={12}/> <span>Modo Monocromático</span></div>
                      <div className={`w-2 h-2 rounded-full ${grayMode ? 'bg-teal-400' : 'bg-neutral-800'}`}></div>
                    </button>
                  </div>
                  <div className="grid grid-cols-2 gap-2">
                    {Object.keys(voltageFilters).map(key => (
                       <button key={key} onClick={() => toggleVoltageFilter(key)} 
                         className={`text-[10px] p-2 rounded border transition-colors text-left flex items-center gap-2
                         ${voltageFilters[key] ? 'bg-neutral-800 border-neutral-600 text-neutral-200' : 'border-neutral-800 text-neutral-600'}`}>
                         <div className="w-1.5 h-1.5 rounded-full" style={{ backgroundColor: voltageFilters[key] ? getVoltageColor(key.replace('+','').replace('-','').split(' ')[0], grayMode) : '#525252' }}></div>
                         {key}
                       </button>
                    ))}
                  </div>
               </div>

               <div>
                  <h3 className="text-xs font-bold text-neutral-500 uppercase mb-3 flex items-center gap-2"><Filter size={14}/> Tipos de Usina</h3>
                  <div className="grid grid-cols-2 gap-2">
                    {Object.keys(plantFilters).map(key => (
                       <button key={key} onClick={() => togglePlantFilter(key)} 
                         className={`text-[10px] p-2 rounded border transition-colors text-left flex items-center gap-2
                         ${plantFilters[key] ? 'bg-neutral-800 border-neutral-600 text-neutral-200' : 'border-neutral-800 text-neutral-600'}`}>
                         <div className="w-1.5 h-1.5 rounded-full" style={{ backgroundColor: plantFilters[key] ? getPlantColor(key) : '#525252' }}></div>
                         {key}
                       </button>
                    ))}
                  </div>
               </div>
             </div>
          )}

          {activeTab === 'legend' && (
             <div className="space-y-4">
               <div><h3 className="text-xs font-bold text-neutral-500 uppercase mb-2">Tensão</h3>
               {[750, 600, 500, 440, 230, 138].map(v => (
                 <LegendItem key={v} color={getVoltageColor(v, grayMode)} label={`${v} kV`} />
               ))}</div>
               <div><h3 className="text-xs font-bold text-neutral-500 uppercase mb-2">Fonte</h3>
               <LegendItem color="#3b82f6" label="Hidrelétrica" /><LegendItem color="#fbbf24" label="Solar" /><LegendItem color="#22d3ee" label="Eólica" /><LegendItem color="#10b981" label="Outras" /></div>
               {showPlanned && (
                 <div><h3 className="text-xs font-bold text-neutral-500 uppercase mb-2">Status</h3>
                 <div className="flex items-center gap-3 py-1">
                    <div className="w-8 h-0 border-t-2 border-dashed border-gray-500"></div>
                    <span className="text-xs text-neutral-300">Planejado / Em Obra</span>
                 </div>
                 </div>
               )}
             </div>
          )}
        </div>
      </div>

      {!sidebarOpen && (
        <div className="absolute top-5 left-5 z-[1000] flex flex-col gap-3">
           <button onClick={() => setSidebarOpen(true)} className="p-3 bg-neutral-900 border border-neutral-700 text-white rounded-lg shadow-xl hover:bg-neutral-800"><Menu size={20} /></button>
           <button onClick={() => { setPulseMode(!pulseMode); clearPulse(); }} className={`p-3 border rounded-lg shadow-xl ${pulseMode ? 'bg-indigo-600 border-indigo-500 animate-pulse' : 'bg-neutral-900 border-neutral-700'}`} title="Pulso"><Waves size={20} /></button>
        </div>
      )}

      {/* Map */}
      <div id="map" ref={mapContainerRef} className={`flex-1 h-full w-full bg-neutral-900 transition-opacity duration-500 ${leafletReady ? 'opacity-100' : 'opacity-0'}`} />
      
      {!leafletReady && <div className="absolute inset-0 z-[2000] flex items-center justify-center bg-neutral-900 text-emerald-500"><Activity className="animate-pulse" size={40} /></div>}
      <div className="absolute bottom-1 right-1 bg-black/50 px-2 py-1 text-[10px] text-gray-500 pointer-events-none z-[400]">ONS | Geist UI</div>
    </div>
  );
}
